diff --git a/ports/snap-c/Makefile b/ports/snap-c/Makefile
index 0881e9e..24e828a 100644
--- a/ports/snap-c/Makefile
+++ b/ports/snap-c/Makefile
@@ -2,14 +2,14 @@ A_PREFIX=snap
 A_SUFFIX=_mkl_vml
 A_TARGET=$(A_PREFIX)$(A_SUFFIX)
 
-CC=mpiicc			# C compiler command
-CFLAGS=-mkl -O3 -xAVX -std=c99 -fopenmp -parallel -DUSEMKL -DUSEVML	# C compiler flags
-#CC=mpicc
-#CFLAGS=-O3 -std=c99 -fopenmp -lm #-wall	# C compiler flags
-LDFLAGS=			# Linker flags, e.g. -L<lib dir> if you have libraries in a nonstandard directory <lib dir>
+# CC=mpiicc			# C compiler command
+# CFLAGS=-mkl -O3 -xAVX -std=c99 -fopenmp -parallel -DUSEMKL -DUSEVML	# C compiler flags
+CC=mpicc
+CFLAGS=-O3 -std=c99 -fopenmp -lm #-wall	# C compiler flags
+LDFLAGS=-Wl,--copy-dt-needed-entries			# Linker flags, e.g. -L<lib dir> if you have libraries in a nonstandard directory <lib dir>
 LIBS=				# Libraries to pass to the linker, e.g. -l<library>
 CPPFLAGS=			# (Objective) C/C++ preprocessor flags, e.g. -I<include dir> if you have headers in a nonstandard directory <include dir>
-CXX=icc				# C++ compiler command
+CXX=gcc				# C++ compiler command
 CXXFLAGS=-O3 -std=c++11 -openmp	# C++ compiler flags
 CXXCPP=				# C++ preprocessor flags
 
diff --git a/ports/snap-c/dim1_sweep.c b/ports/snap-c/dim1_sweep.c
index e72a5a2..a2fc863 100644
--- a/ports/snap-c/dim1_sweep.c
+++ b/ports/snap-c/dim1_sweep.c
@@ -73,11 +73,14 @@ void dim1_sweep ( input_data *input_vars, geom_data *geom_vars,
 
     double psi[NANG], pc[NANG], den[NANG];
 
+    #undef NANG
+    int NANG = input_vars->nang;
+    #pragma scop
     for ( ang = 0; ang < NANG; ang++ )
     {
-        psi[NANG] = 0;
-        pc[NANG]  = 0;
-        den[NANG] = 0;
+        psi[ang] = 0;
+        pc[ang]  = 0;
+        den[ang] = 0;
     }
 
     double hv[NANG*2], fxhv[NANG*2], qm[NANG*NX];
@@ -368,5 +371,6 @@ A
 //    FREE(hv);
 //    FREE(fxhv);
 //    FREE(qm);
+    #pragma endscop
 }
 
diff --git a/ports/snap-c/dim3_sweep.c b/ports/snap-c/dim3_sweep.c
index 7175b3a..157c884 100644
--- a/ports/snap-c/dim3_sweep.c
+++ b/ports/snap-c/dim3_sweep.c
@@ -67,6 +67,8 @@ void dim3_sweep ( input_data *input_vars, para_data *para_vars,
 /***********************************************************************
  * Local variables
  ***********************************************************************/
+  #undef NANG
+  int NANG = input_vars->nang;
     int ist, d, n, ic, i, j, k, l, ibl, ibr, ibb, ibt, ibf, ibk;
 
     int z_ind, y_ind, ic_ind, ang, indx1 = 4;
@@ -81,6 +83,7 @@ void dim3_sweep ( input_data *input_vars, para_data *para_vars,
         mu_hv[NANG], hj_hv[NANG], hk_hv[NANG], w_psi[NANG];
 
     double unit_vec[indx1];
+  #pragma scop
     for ( i = 0; i < indx1; i++ )
     {
         unit_vec[i] = 1;
@@ -133,7 +136,7 @@ void dim3_sweep ( input_data *input_vars, para_data *para_vars,
             FXHV_2D(ang, i) = 0;
         }
     }
-
+    #pragma endscop
 /***********************************************************************
  * Loop over cells along the diagonals. When only 1 diagonal, it's
  * normal sweep order. Otherwise, nested threading performs mini-KBA.
