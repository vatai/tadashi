name: Run tests
on: push

jobs:
  build_deps:
    name: Build deps
    runs-on: ubuntu-latest
    steps:

    - name: Install packages üì¶
      run: >
        sudo apt-get install -y
        git build-essential autoconf pkg-config libtool libc++-dev
        libyaml-dev libntl-dev libgmp-dev llvm-17 clang-17 llvm-17-dev
        libclang-17-dev libpolly-17-dev swig
        openmpi-bin openmpi-common libopenmpi-dev nlohmann-json3-dev

    - name: Set up Python üêç
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        # cache: 'pip'

    # - name: Install mpi4py
    #   run: python -m pip install mpi4py halo --user

    - name: Check out repo üò∏
      uses: actions/checkout@master
      with:
        submodules: recursive

    - name: Build deps
      run: third_party/install.sh

  run_tests:
    name: Run tests
    needs: [build_deps]
    runs-on: ubuntu-latest
    steps:
    - name: Build python package
      run: pip install .

    - name: Run end2end.py
      run: python examples/end2end.py

    - name: Run unittests
      run: python -m unittest
